SELECT 
    COALESCE(
        (SELECT Titulo FROM valorestipo WHERE Codigo = vc.IdValorTipo LIMIT 1), 
        CONCAT('Codigo ', vc.IdValorTipo)
    ) as medio_pago,
    SUM(vc.Monto) as total_cobrado

FROM ventas_cobranzas vc
INNER JOIN ventas v ON 
    vc.IdVenta = v.IdVenta 
    AND vc.IdSucursal = v.IdSucursal

WHERE 
    v.FechaContable >= '{{ DatePicker1.formattedDate }}'
    AND v.FechaContable <= '{{ DatePicker2.formattedDate }}'
    
    -- ðŸ‘‡ FILTRO DE ESTADO
    AND v.Estado = 'C'

    -- Filtros UI
    AND v.IdSucursal IN ({{ MultiTreeSelect1.selectedOptionValues.length > 0 ? MultiTreeSelect1.selectedOptionValues.join(',') : '0' }})
    AND (
        {{ MultiTreeSelect2.selectedOptionValues.length === 0 }} 
        OR 
        vc.IdValorTipo IN ({{ MultiTreeSelect2.selectedOptionValues.length > 0 ? MultiTreeSelect2.selectedOptionValues.join(',') : '0' }})
    )

GROUP BY vc.IdValorTipo
ORDER BY total_cobrado DESC