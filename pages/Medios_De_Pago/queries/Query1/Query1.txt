SELECT 
    Cobros.Medio_Pago,

    -- Cantidad de tickets reales
    COUNT(DISTINCT Ventas.IdVenta) as Cantidad_Tickets,

    -- 1. TOTAL VENTA REAL (LÃ³gica Condicional)
    SUM(
        CASE 
            -- A. Seguridad: Si es Propina o Retiro (Negativo), no suma nunca.
            WHEN Cobros.Monto <= 0 THEN 0

            -- B. CASO EFECTIVO: Sumamos TODO (Fiscal + TNF)
            -- Porque el TNF en efectivo es plata real en el cajÃ³n.
            WHEN Cobros.Medio_Pago = 'Efectivo' THEN Cobros.Monto

            -- C. CASO TARJETAS (Visa, MP, etc): 
            -- Si es TNF, lo ignoramos (0). Solo sumamos si es Fiscal.
            WHEN Ventas.FiscalType LIKE '%TNF%' THEN 0

            -- D. Resto (Tarjetas Fiscales): Sumamos.
            ELSE Cobros.Monto
        END
    ) as Total_Venta_Real,

    -- 2. TOTAL NO FACTURADO (Informativo)
    -- AquÃ­ mostramos todo lo que sea TNF, para que tengas el control,
    -- aunque arriba hayamos decidido no sumarlo al total de tarjetas.
    SUM(
        CASE 
            WHEN Cobros.Monto <= 0 THEN 0
            WHEN Ventas.FiscalType LIKE '%TNF%' THEN Cobros.Monto
            ELSE 0 
        END
    ) as Total_No_Facturado,

    -- 3. TOTAL FACTURADO (Solo Fiscales)
    SUM(
        CASE 
            WHEN Cobros.Monto <= 0 THEN 0
            WHEN Ventas.FiscalType NOT LIKE '%TNF%' THEN Cobros.Monto
            ELSE 0 
        END
    ) as Total_Facturado_Real,

    -- 4. TOTAL IVA
    SUM(
        CASE 
            WHEN Cobros.Monto <= 0 THEN 0
            WHEN Ventas.MontoTotal <= 0 THEN 0
            WHEN Ventas.FiscalType LIKE '%TNF%' THEN 0
            ELSE (Cobros.Monto / Ventas.MontoTotal) * Ventas.MontoIVA
        END
    ) as Total_IVA_Real

FROM 
    -- ðŸŸ¢ COLADOR 1: Limpiamos duplicados de VENTAS (Facturas repetidas)
    (
        SELECT DISTINCT 
            IdVenta, 
            IdSucursal, 
            Factura_ComprobanteFiscal as FiscalType, 
            Factura_MontoTotal as MontoTotal, 
            Factura_MontoIVA as MontoIVA
        FROM ventas
        WHERE 
            IdSucursal IN ( {{ MultiTreeSelect1.selectedOptionValues.length > 0 ? MultiTreeSelect1.selectedOptionValues.join(',') : '0' }} )
            AND FechaContable >= '{{ DatePicker1.formattedDate }}'
            AND FechaContable <= '{{ DatePicker2.formattedDate }}'
            AND Estado = 'C'
    ) Ventas

    INNER JOIN 

    -- ðŸ”µ COLADOR 2: Limpiamos duplicados de COBROS (Filas repetidas exactas)
    (
        SELECT DISTINCT 
            vc.IdVenta, 
            vc.IdSucursal, 
            vt.Titulo as Medio_Pago, 
            vc.Monto
        FROM ventas_cobranzas vc
        INNER JOIN valorestipo vt ON vc.IdValorTipo = vt.Codigo
    ) Cobros 
    ON Ventas.IdVenta = Cobros.IdVenta AND Ventas.IdSucursal = Cobros.IdSucursal

GROUP BY Cobros.Medio_Pago
ORDER BY Total_Venta_Real DESC;