SELECT 
    COUNT(DISTINCT v.IdVenta) as cantidad_tickets,
    
    -- Sumamos los cobros
    SUM(vc.Monto) as total_vendido,

    -- Desglose proporcional (Mismo c√°lculo de antes)
    SUM(CASE 
        WHEN COALESCE(v.Factura_ComprobanteFiscal, '') <> 'TNF' THEN vc.Monto 
        ELSE 0 
    END) as total_facturado,

    SUM(CASE 
        WHEN COALESCE(v.Factura_ComprobanteFiscal, '') = 'TNF' THEN vc.Monto 
        ELSE 0 
    END) as total_no_facturado,

    SUM(
        CASE 
            WHEN v.Factura_MontoTotal > 0 
            THEN (vc.Monto / v.Factura_MontoTotal) * v.Factura_MontoIVA
            ELSE 0 
        END
    ) as total_iva

FROM ventas_cobranzas vc
INNER JOIN ventas v ON 
    vc.IdVenta = v.IdVenta 
    AND vc.IdSucursal = v.IdSucursal -- üîí Candado 1: Misma Sucursal

WHERE 
    v.FechaContable >= '{{ DatePicker1.formattedDate }}'
    AND v.FechaContable <= '{{ DatePicker2.formattedDate }}'
    
    -- üîí Candado 2: Asegurar que el cobro no sea viejo (opcional pero recomendado)
    -- Si 'ventas_cobranzas' tiene fecha, √∫sala. Si no, confiamos en el JOIN de arriba.
    
    AND v.IdSucursal IN ({{ MultiTreeSelect1.selectedOptionValues.length > 0 ? MultiTreeSelect1.selectedOptionValues.join(',') : '0' }})

    AND (
        {{ MultiTreeSelect2.selectedOptionValues.length === 0 }} 
        OR 
        vc.IdValorTipo IN ({{ MultiTreeSelect2.selectedOptionValues.length > 0 ? MultiTreeSelect2.selectedOptionValues.join(',') : '0' }})
    )