SELECT 
    COUNT(DISTINCT v.IdVenta) as cantidad_tickets,
    
    -- 1. TOTAL VENDIDO: Sumamos directamente los pagos (coincidir치 con el gr치fico)
    SUM(vc.Monto) as total_vendido,

    -- 2. DESGLOSE "BLANCO" (Facturado) PROPORCIONAL
    -- Si el ticket es Fiscal, sumamos este pago al total facturado
    SUM(CASE 
        WHEN COALESCE(v.Factura_ComprobanteFiscal, '') <> 'TNF' THEN vc.Monto 
        ELSE 0 
    END) as total_facturado,

    -- 3. DESGLOSE "NEGRO" (No Facturado) PROPORCIONAL
    -- Si el ticket es TNF, sumamos este pago al total NO facturado
    SUM(CASE 
        WHEN COALESCE(v.Factura_ComprobanteFiscal, '') = 'TNF' THEN vc.Monto 
        ELSE 0 
    END) as total_no_facturado,

    -- 4. IVA PROPORCIONAL (C치lculo matem치tico)
    -- Regla de 3: (MontoPago / MontoTotalTicket) * MontoIVAOriginal
    SUM(
        CASE 
            WHEN v.Factura_MontoTotal > 0 AND v.Factura_MontoIVA > 0
            THEN (vc.Monto / v.Factura_MontoTotal) * v.Factura_MontoIVA
            ELSE 0 
        END
    ) as total_iva

FROM ventas_cobranzas vc
INNER JOIN ventas v ON vc.IdVenta = v.IdVenta

WHERE 
    v.FechaContable >= '{{ DatePicker1.formattedDate }}'
    AND v.FechaContable <= '{{ DatePicker2.formattedDate }}'
    
    -- Filtro de Sucursal (Blindado)
    AND v.IdSucursal IN ({{ MultiTreeSelect1.selectedOptionValues.length > 0 ? MultiTreeSelect1.selectedOptionValues.join(',') : '0' }})

    -- Filtro de Medio de Pago (Blindado)
    AND (
        {{ MultiTreeSelect2.selectedOptionValues.length === 0 }} 
        OR 
        vc.IdValorTipo IN ({{ MultiTreeSelect2.selectedOptionValues.length > 0 ? MultiTreeSelect2.selectedOptionValues.join(',') : '0' }})
    )