{
  "gitSyncId": "694ebec5a56d53482b864ab0_ef87f89b-64a7-487b-91b3-edf37f404f21",
  "id": "Facturacion_Odoo_Stock_Query",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "SELECT \n  -- 1. TOTAL FACTURACIÓN (De lo filtrado)\n  SUM(total) as total_ventas,\n\n  -- 2. TOTAL BULTOS Y UNIDADES (General)\n  SUM(cantidad) as total_bultos,\n  SUM(cantidad * COALESCE(SUBSTRING(producto FROM '[xX]\\s*([0-9]+)')::INTEGER, 1)) as total_unidades,\n\n  -- 3. CÁLCULO DE KILOS DE MUZZARELLA\n  SUM(\n    CASE \n      -- Si dice 330 gr y x 25 u. -> (Cantidad * 25 * 0.330 kg)\n      WHEN producto ILIKE '%330%' AND (producto ILIKE '%x 25%' OR producto ILIKE '%x25%') \n      THEN cantidad * 25 * 0.330\n      \n      -- Si dice 110 gr y x 25 u. -> (Cantidad * 25 * 0.110 kg)\n      WHEN producto ILIKE '%110%' AND (producto ILIKE '%x 25%' OR producto ILIKE '%x25%') \n      THEN cantidad * 25 * 0.110\n      \n      -- Si dice 500 gr (se asume individual) -> (Cantidad * 0.500 kg)\n      WHEN producto ILIKE '%Muzzarella%' AND producto ILIKE '%500%' \n      THEN cantidad * 0.500\n      \n      ELSE 0 \n    END\n  ) as kilos_muzzarella,\n\n  -- 4. CÁLCULO DE KILOS DE PROVOLONE\n  SUM(\n    CASE \n      -- Si dice 100 gr y x 25 u.\n      WHEN producto ILIKE '%100%' AND (producto ILIKE '%x 25%' OR producto ILIKE '%x25%') \n      THEN cantidad * 25 * 0.100\n      \n      -- Si dice 25 gr y x 25 u.\n      WHEN producto ILIKE '%25%' AND producto NOT ILIKE '%x 25%' AND (producto ILIKE '%x 25%' OR producto ILIKE '%x25%') \n      THEN cantidad * 25 * 0.025\n      \n      -- Si dice 500 gr\n      WHEN producto ILIKE '%Provolone%' AND producto ILIKE '%500%' \n      THEN cantidad * 0.500\n      \n      ELSE 0 \n    END\n  ) as kilos_provolone\n\nFROM public.ordenes_compras_odoo\n\nWHERE\n  -- 1. FECHAS (Stock)\n  ( {{ !FechaDesdeStock.formattedDate }} OR fecha >= TO_DATE({{ FechaDesdeStock.formattedDate }}, 'DD-MM-YYYY') )\n  AND\n  ( {{ !FechaHastaStock.formattedDate }} OR fecha <= TO_DATE({{ FechaHastaStock.formattedDate }}, 'DD-MM-YYYY') )\n  AND\n  -- 2. CLIENTE (Stock)\n  ( {{ SelectClienteStock.selectedOptionValues.length === 0 }} OR cliente = ANY ({{ SelectClienteStock.selectedOptionValues }}) )\n  AND\n  -- 3. PRODUCTO (Stock) -> ¡ESTE ES EL NUEVO!\n  ( {{ SelectProductoStock.selectedOptionValues.length === 0 }} OR producto = ANY ({{ SelectProductoStock.selectedOptionValues }}) )",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Untitled datasource 1",
      "isAutoGenerated": false,
      "name": "Untitled datasource 1",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Stock_Query",
    "pageId": "Facturacion_Odoo",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}